#一致性/giHash/nz
一/nz./nz前言/gi一致性/gi哈希/nrf(/nzconsistent hashing/nz)/nz，/w最早/d由/pmit/gi的/ude1karger/nz于/p1997/nz年/qt提出/v，/w主要/b用于/v解决/v易变/nz的/ude1分布式/giweb系统/gi中/f，/w由于/p宕机/nz和/cc扩容/v导致/gi的/ude1服务/gi震荡/vn。/w现在/t这个/rz算法/gi思路/gi被/pbei大量/m应用/gi，/w并且/c在实践中/n得到/v了/ule很大/d的/ude1发展/gi。/w二.算法/nz设计/gi1./nz问题/gi来源/gi一个/mq由/p6/nz台/q服务器/gi组成/gi的/ude1服务/gi，/w每/rz台/qserver/gi负责/v存储/gi1/nz//nz6/nz的/ude1数据/gi，/w当/pserver/gi1/nz出现/v宕机/nz之后/f，/w服务/gi重新/d恢复/gi可用/v时/qt的/ude1场景/gi。/w如下/vi表/n可以/v很/d清楚/a的/ude1看到/v，/w当/pserver/gi1/nz宕机/nz时/qt，/whash/gi1/nz的/ude1服务/gi完全/ad不/d可用/v了/ule，/w所以/c需要/vrehash/nz由/p剩余/vn5/nz台/q机器/gi提供/v所有/b的/ude1数据服务/n，/w但/c由于/p每/rz台/q机器/gi负责/v的/ude1数据/gi段/q大小/n不/d相同/a，/w那么/c需要/v在/p不同/a的/ude1服务器之间/n大量/m迁移/gi数据/gi，/w并且/c数据/gi迁移/gi完成/v之前/f服务/gi会/v不/d可用/v。/w2./nz经典/gi一致性/gi哈希算法/gi针对/girehash/nz的/ude1弊端/n，/wkarger/nz提出/v了/ule一种/nz算法/gi，/w算法/gi的/ude1核心/n是/vshi”/w虚拟节点/gi”/w。/w将/d所有/b的/ude1数据/gi映射/gi成/v一/nz组/n大于/v服务器/gi数量/n的/ude1虚拟节点/gi，/w虚拟节点/gi再/d映射/gi到/v真实/a的/ude1服务器/gi。/w所以/c当/p服务器/gi宕机/nz时/qt，/w由于/p虚拟节点/gi的/ude1数量/n固定/a不变/nz，/w所有/b不/d需要/vrehash/nz，/w而/cc只/d需要/v将/d服务/gi不/d可用/v的/ude1虚拟节点/gi重新/d迁移/gi，/w这样/rzv只/d需要/v迁移/gi宕机/nz节点/gi的/ude1数据/gi。/w经典/gi的/ude1算法/gi中/f，/w宕机/nz服务器/gi的/ude1下一个/nz真实/a节点/gi将/d提供/v服务/gi。/w三.算法/nz改进/gi1./nz经典/gi一致性/gi哈希算法/gi的/ude1问题/gi经典/gi的/ude1算法/gi只是/d解决/v了/ulerehash/nz算法/gi的/ude1缺陷/gi，/w当/p本身/rz并不/d完美/a。/w主要/b存在/v以下/f几个/nz问题/gi：/w(/nz1/nz)/nzserver/gi1/nz宕/n机会/gi导致/giserver/gi2/nz的/ude1服务/gi承受/v一倍/nz的/ude1数据服务/n，/w且/c如果/cserver/gi1/nz就此/d退役/vi，/w那么/c整个/b系统/gi的/ude1负载/gi完全/ad不/d均衡/a了/ule。/w(/nz2/nz)/nz如果/c所有/b的/ude1server/gi都/d能/v承受/v一倍/nz的/ude1数据/gi读写/gi，/w那么/c如果/c在/p正常/a情况下/nz所有/b的/ude1数据/gi写/v两/nz份/q到/v不同/a的/ude1服务器/gi，/w主备/nz或者/c负载均衡/gi，/w宕机/nz时/qt直接/ad读/v备份/gi节点/gi的/ude1数据/gi，/w根本/a不/d需要/v出现/v经典/gi算法/gi中的/v数据/gi迁移/gi。/w2./nzdynamo/nz改进/gi实践/giamazon/nz的/ude1大数据存储/gi平台/gi”/wdynamo/nz”/w使用/gi了/ule一致性/gi哈希/nrf，/w但/c它/rr并/cc没有/v使用/gi经典/gi算法/gi，/w而是/c使用/gi了/ule故障/gi节点/girehash/nz的/ude1思路/gi。/w系统/gi将/d所有/b的/ude1虚拟节点/gi和/cc真实/a服务器/gi的/ude1对应/vi关系/gi保存/gi到/v一个/mq配置/gi系统/gi，/w当/p某些/rz虚拟节点/gi的/ude1服务/gi不/d可用/v时/qt，/w重新配置/n这些/rz虚拟节点/gi的/ude1服务/gi到/v其他/rzv真实/a服务器/gi，/w这样/rzv既/c不用/d大量/m迁移/gi数据/gi，/w也/d保证/v了/ule所有/b服务器/gi的/ude1负载/gi相对/d均衡/a。/w虚拟节点/gi0/nz-/nz4/nz//nz510/nz-/nz14/nz//nz615/nz-/nz19/nz//nz720/nz-/nz24/nz//nz824/nz-/nz29/nz//nz9/nz恢复/giserver/gi0/nzserver/gi2/nzserver/gi3/nzserver/gi4/nzserver/gi5/nz四.算法/nz扩展/gi一致性/gi哈希算法/gi本身/rz是/vshi用于/v解决/v服务器/gi宕机/nz与/cc扩容/v的/ude1问题/gi，/w但/c”/w虚拟节点/gi”/w的/ude1算法/gi思想/gi有所发展/v，/w一些/m分布式/gi的/ude1系统/gi用于/v实现/gi系统/gi的/ude1负载均衡/gi和/cc最优/ad访问/gi策略/gi。/w在/p真实/a的/ude1系统/gi情况下/nz，/w相同/a部署/gi的/ude1两/nz套/q系统/gi可能/v不能/v提供/v相同/a的/ude1服务/gi，/w主要/b原因/n：/w(/nz1/nz)/nz硬件/gi个体差异/nz导致/gi服务器/gi性能/gi不同/a。/w(/nz2/nz)/nz机房/gi交换机/gi和/cc网络带宽/gi导致/giidc/gi服务器之间/n的/ude1网络通信/gi效率/gi不同/a。/w(/nz3/nz)/nz用户/gi使用/gi不同/a的/ude1网络/gi运营商/gi导致/gi电信/nidc/gi和/cc联通/vidc/gi提供/v的/ude1服务/gi性能/gi不同/a。/w(/nz4/nz)/nz服务器/gi所在/n网络/gi或/c机房/gi遭遇/v攻击/gi。/w所以/c完全相同/nz的/ude1两/nz套/q系统/gi可能/v也/d需要/v提供/v差异化/nz的/ude1服务/gi，/w通过/p使用/gi虚拟节点/gi可以/v灵活/a的/ude1动态/gi调整/vn，/w达到/v系统/gi服务/gi的/ude1最优化/gm。/w对于/p由/p2/nz个/q节点/gi，/w每个/r节点/gi3/nz台/q服务器/gi组成/gi的/ude1分布式系统/gi，/ws/nz0/nz-/nz1/nz为/p分布式系统/gi1/nz的/ude1server/gi0/nz，/w系统配置/gi管理员/gi可以/v根据/p系统/gi真实/a的/ude1服务/gi效率/gi动态/gi的/ude1调整/vn虚拟节点/gi与/cc真实/a服务器/gi的/ude1映射/gi关系/gi，/w也/d可以/v由/p客户/n系统/gi自身/rr根据/p响应/v率/v或/c响应/v时间/gi等/udeng情况/n调整/vn自身/rr的/ude1访问/gi策略/gi。/w虚拟节点/gi0/nz-/nz23/nz-/nz45/nz-/nz78/nz-/nz910/nz-/nz1213/nz-/nz14/nz服务器/gis/nz0/nz-/nz1/nzs/nz0/nz-/nz2/nzs/nz1/nz-/nz1/nzs/nz1/nz-/nz2/nzs/nz2/nz-/nz1/nzs/nz2/nz-/nz2/nz