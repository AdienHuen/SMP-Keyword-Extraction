#Redis/gi缓存/gi和/ccRabbitMQ/nz消息/n解决/v购车/v问题/gi（/w用户/gi登录/gi，/w用户/gi未/d登录/gi和/cc购物车/gi合并/gi）/w
在/p逛/v各/rz大/a电商/gi网站/gi的/ude1时候/n，/w总会/nis有/vyou将/d商品/gi加入/v购物车/gi，/w然后/c合并/gi付款/vi，/w这个/rz大大的/nz提高/v了/ule用户/gi的/ude1体验/v，/w某/rz东/f更是/d任性/a，/w在/p未/d登录/gi的/ude1情况下/nz都/d可以/v将/d商品/gi加入/v购物车/gi，/w但是/c任性/a总是/d有/vyou代价/gi的/ude1，/w后面/f我会/r说/v一/nz下/f这个/rz小/abug/gi。/w可能/v不/d算是/v个/qbug/gi，/w但是/c体验/v上/f也/d有/vyou不爽/nz的/ude1地方/n。/w还是/c谈谈/v购物车/gi是/vshi如何/ryv实现/gi的/ude1吧/y，/w购物车/gi首先/d标识/n要/v唯一/b，/w因为/c每个/r账号/gi要/v对应/vi一个/mq购物车/gi，/w在/p登录/gi状态/gi下/f，/w我们/rr可以/v直接/ad将/d数据保存/gi到/v数据库/gi中/f，/w使用/gi用户/gi的/ude1id/nz表示/v自己/rr购买/gi的/ude1商品/gi，/w但是/c如果/c在/p未/d登录/gi状态/gi下/f呢/y，/w或者/c对/p购车/v访问量/nz大/a的/ude1时候/n，/w这个/rz就/d存在/v弊端/n，/w因为/c这样/rzv高速/b的/ude1读写/gi数据库/gi，/w会/v对/p数据库/gi的/ude1压力/n比较/gi大/a，/w在/p这里/rzs我们/rr就/d看看/v如何/ryv用/predis/gi和/ccrabbitmq/nz解决/v这个/rz问题/gi。/w第一章/nz：/w登录/gi状态/gi下/f添加/gi商品/gi到/v购物车/gi此时/r购物车/gi是/vshi对应/vi一个/mq用户/gi，/w很/d简单/a，/w就是/v将/d商品/gi的/ude1数据/gi插入/gi数据库/gi中/f即可/v，/w但是/c如果/c读写/gi频繁/a的/ude1时候/n，/w就/d存在/v压力/n问题/gi，/w此时/r我们/rr可以/v使用/giredis/gi担任/v读/v的/ude1部分/n功能/gi。/w在/p向/p数据库/gi中/f插入/gi数据/gi的/ude1时候/n，/w使用/girabbitmq/nz发送/gi消息/n，/w然后/c有/vyou一个/mq消息系统/nz监听/gi消息/n，/w将/drabbitmq/nz中/f消息/n内容/gi(/nz插入/gi数据库/gi中的/v商品/gi数据/gi)/nz保存/gi到/vredis/gi中/f，/w但是/c此时/rredis/gi中/f我们/rr该/rz用/p什么/ry存储结构/gi，/w在/predis/gi中/f存储结构/gi有/vyou很/d多/a种/q，/w这里/rzs我们/rr使用/gihash/gi结构/gi，/w看/v下面/f的/ude1图/gi，/w分析/gi一下/mhash/gi结构/gi：/w从/p上面/f的/ude1图/gi我们/rr可以/v看/v的/ude1出来/vf，/w这个/rz图/gi有/vyou两/nz个/q键/n，/w一个/mq是/vshi外部/f键/n，/w一个/mq是/vshi内部/f键/n，/w这个/rz就/d体现/v了/ule购物车/gi的/ude1好处/gi，/w这里/rzs外部/f键/n可以/v标记/gi一个/mq唯一/b的/ude1购物车/gi，/w内部/f键/n就/d可以/v标记/gi购物/vn车上/s的/ude1一个/mq商品/gi，/w一个/mq外部/f键/n可以/v对应/vi多/a个/q内部/f键/n，/w这个/rz和/cc一个/mq购物/vn车里/d有/vyou多/a个/q商品/gi是/vshi相符合/nz的/ude1，/w在/p用户/gi查询/gi自己/rr的/ude1购物车/gi数据/gi的/ude1时候/n，/w就/d不要/d到/v数据库/gi中/f查询/gi，/w而是/c直接/ad从/predis/gi中将/nnt数据/gi拿出/v来/vf即可/v，/w这样/rzv数据库/gi的/ude1读/v压力/n就/d被/pbeiredis/gi分担/gi出去/vf了/ule。/w就/d这样/rzv把/pba登录/gi状态/gi下/f购物车/gi问题/gi解决/v了/ule。/w第二章/nz：/w未/d登录/gi下/f加入/v购物车/gi，/w登录/gi下/f合并/gi购物车/gi在/p未/d登录/gi状态/gi下/f，/w没有/v指定/v的/ude1用户/gi，/w此时/r购物车/gi应该/v怎么/ryv分配/gi，/w数据/gi把/pba偶/d才能/n在/p什么/ry位置/gi，/w这个/rz其实/d也/d不难/d，/w我们/rr可以/v将/d数据/gi临时/gi保存/gi到/vredis/gi中/f，/w并不/d插入/gi数据库/gi中/f，/w因为/c此时/r没有/v对应/vi的/ude1用户/gi，/wredis/gi生成/v一个/mq唯一/b的/ude1outerkey/nz，/w保存/gi到/vcookie/gi中/f，/w每次/r添加/gi商品/gi，/w带上/v这个/rzcookie/gi，/w这样/rzv就/d保证/v每次/r加入/v同一个/b购物车/gi，/w这个/rz数据/gi会/v被/pbei保存/gi一段时间/nz，/w当/p用户/gi登录/gi的/ude1时候/n，/w我们/rr该/rz如何/ryv将/d未/d登录/gi状态/gi下/f的/ude1购车和/n登录/gi状态/gi下/f的/ude1购车/v数据/gi合并/gi呢/y。/w这个/rz就/d需要/v使用/gi到/v消息/n了/ule，/w我们/rr可以/v发送/gi一个/mq消息/n给/p后台/gi系统/gi，/w将/d未/d登录/gi状态/gi下/f的/ude1outerkey/nz传递/v给/p后台/gi系统/gi，/w后台/gi系统/gi到/vredis/gi中/f查询/gi到/v未/d登录/gi状态/gi下/f的/ude1购物车/gi，/w将/d购物车/gi中的/v数据/gi插入/gi到/v数据库/gi中/f，/w和/cc之前/f登录/gi状态/gi下/f的/ude1购车/v数据/gi合并/gi，/w重新/d缓存/gi到/vredis/gi中/f，/w此时/r缓存/gi到/vredis/gi中的/v购物车/gi是/vshi和/cc未/d登录/gi状态/gi不同/a的/ude1，/w因为/c这个/rz缓存/gi的/ude1购物车/gi是/vshi有/vyou主人/n的/ude1，/w未/d登录/gi状态/gi下/f缓存/gi的/ude1临时/gi购物车/gi是/vshi没有/v主人/n的/ude1。/w小小/zbug/gi的/ude1解析/gi：/w在/p开头/n我们/rr曾/d说/v到/v未/d登录/gi状态/gi下/f加入/v临时/gi购物车/gi，/w登录/gi后/f合并/gi到/v登录/gi用户/gi的/ude1购物车/gi中/f，/w接下来/vl我/rr看/v一/nz下/f这个/rz场景/gi。/w小王/nz用/p小李/nz的/ude1电脑/gi逛商城/nz，/w没有/v登录/gi，/w将/d看中/v的/ude1商品/gi加入/v到/v了/ule临时/gi的/ude1购物车/gi中/f，/w小王/nz还/d没有/v来得及/v登录/gi自己/rr的/ude1账号/gi结算/vn购物车/gi，/w因/p有/vyou事/n出去/vf了/ule一下/m，/w此时/r小李/nz回来/v了/ule，/w他/rr想到/v之前/f自己/rr的/ude1购物/vn车里/d还有/v商品/gi需要/v付款/vi，/w他/rr就/d毫不犹豫/dl的/ude1登录/gi了/ule自己/rr的/ude1账号/gi，/w这时候/rzt问题/gi来/vf了/ule，/w小王/nz之前/f临时/gi购物车/gi中的/v商品/gi都会/n合并/gi到/v小李/nz的/ude1账户/n下/f，/w小李/nz的/ude1购物车/gi凭空出现/i自己/rr未/d加入/v购物车/gi的/ude1商品/gi。/w过/uguo了/ule一会/m小王/nz回来/v了/ule，/w发现自己/l临时/gi购物车/gi中的/v数据/gi都/d没有/v了/ule。/w这样/rzv是不是/v就/d存在/v用户/gi体验/v的/ude1问题/gi，/w俗称/v灵异/nz事件/gi，/w呵呵/e，/w开/v个/q玩笑/n。/w这种/r情况/n就/d导致/gi了/ule用户/gi的/ude1体验/v不好/a了/ule。/w上面/f的/ude1问题/gi我/rr也/d想/v过/uguo解决方案/gi，/w但是/c无果/c，/w求/v各路/r大神/nz共同/d解决/v。/w疑问/n解决/v：/w1/nz、/wredis/gi担任/v读/v的/ude1问题/gi，/w当/p像/v双/q11/nz这种/r大量/m访问/gi的/ude1情况下/nz，/wredis/gi会/v不会/v崩溃/vi？/w这个/rz问题/gi我/rr也/d想/v过/uguo，/w这个/rz我们/rr可以/v考虑/v使用/giredis/gi的/ude1集群/gi，/w这样/rzv就/d可以/v解决/v大部分/n的/ude1问题/gi。/w2/nz、/w数据库/gi也/d可以/v做/v读写/gi分离/vi，/w为什么/ryv要/v使用/giredis/gi担任/v读/v呢/y，/w直接/ad使用/gi读写/gi分离/vi不/d就/d可以/v了/ule吗/y？/w数据库/gi的/ude1读写/gi分离/vi的确/d可以/v解决问题/v，/w但是/c像/vredis/gi这种/r非关系型数据库/gi比较/gi明显/a的/ude1优点/gi就是/v数据处理/gi效率高/nz，/w读写/gi分离/vi和/ccredis/gi的/ude1效率/gi相比较/nz来说/uls，/w个人感觉/n还是/c使用/giredis/gi可靠/a。/w3/nz、/w在/p文章/gi中/f提到/vrabbitmq/nz消息/n机制/gi，/w这个/rz到底/d怎么/ryv用/p？/w这个/rz吗/y，/w说来话长/vl，/w在/p接下来/vl的/ude1博文/nz中/f我会/r慢慢/d的/ude1道/qv来/vfrabbitmq/nz的/ude1基本/a使用/gi和/ccrabbitmq/nz与/ccspring/gi的/ude1整合/gi。/w如果/c还/d存在/v什么/ry疑问/n，/w很/d欢迎/v你/rr回复/v本帖/n，/w大家/rr一起/s讨论/gi。/w