#三种/nzVMware/nz数据备份/nz和/cc恢复/gi方法/gi
　　/nz服务器虚拟化/gi，/w尤其/d是/vshivmware/gi形式/gi的/ude1服务器虚拟化/gi使/vit/gi人员/gi获益/vi良多/z，/w这么/rz说一点/nz也/d不为过/l。/w据/p我们/rr所见/c，/w服务器虚拟化/gi能/v解决/v服务器/gi扩张/vn、/w资源/gi消耗/gi、/w服务器/gi扩张/vn、/w能源消耗/nz、/w高可用性/n等/udeng相关/vn问题/gi。/w服务器虚拟化/gi也/d使/v我们/rr有/vyou更多/ad的/ude1时间/gi解决/v其它/rz的/ude1迫切/gi问题/gi，/w如/v企业/gi资源/gi预案/n升级/vi、/w存储/gi项目/gi再三/d迁移/gi或者/c为什么/ryv《/w星舰/nz迷航/v记/v /x11/nz》/w要到/v2009/nz年/qt才/d上映/v。/w　　/nz尽管/cvmware/gi提供/v封装/gi技术/gi和/cc抽象/gi技术/gi，/w使/v我们/rr受益匪浅/gi，/w但/c数据保护/n领域/gi发生/v的/ude1基本/a变革/gi也/d带来/v了/ule各项/r挑战/gi。/w即使/c出现/v了/ulevmware/gi虚拟化/gi，/w备份/gi人员/gi依然/d是/vshi牢骚/n最多/ad的/ude1it/gi人员/gi。/w最大/gm的/ude1挑战/gi在于/v保证数据/n的/ude1一致性/gi，/w解决/vvmware/gi物理/n资源/gi过度/d消耗/gi的/ude1问题/gi。/w　　/nzvmware/gi能/v将/d物理/n服务器/gi封装/gi成/v大型/b的/ude1硬盘/gi图像文件/nz―/w―/w虚拟机/gi磁盘/gi式/k(/nzvmdk/nz)/nz文件/gi，/w因此/c我们/rr不禁/d认为/v：/w备份/gi整台/n服务器/gi应该/v和/cc备份/gi这些/rzvmdk/nz文件/gi(/nz当然/d也/d包括/v相关/vn的/ude1配置文件/gi)/nz一样/uyy简单/a。/w　　/nz但是/c在/p大/a多数/a情况下/nz，/w事实/n并非如此/vl。/w除非/c已经/d关闭/gi虚拟机/gi(/nzvm/nz)/nz，/w否则/c，/w在/p运行/gi状态/gi下/f备份/givm/nz不能/v覆盖/gi所有/b文件/gi。/w换句话说/c，/w这种/r备份/gi方式/n不能/v保证数据/n的/ude1一致性/gi，/w因而/c也/d不能/v保证/v已/d恢复/gi的/ude1vm/nz包含/v足够/v的/ude1精确/gi信息/gi，/w不能/v说明/v服务器/gi已/d成功/a恢复/gi。/w　　/nz至于/p资源/gi过度/d消耗/gi的/ude1问题/gi，/w这/rzv是/vshi虚拟化/gi的/ude1副作用/n。/w利用/vvmware/gi使/v系统/gi虚拟化/gi的/ude1一个/mq关键/n原因/n是/vshi，/w将/d资源/gi消耗/gi集中/v在/p较少/ad的/ude1物理/n服务器/gi中/f，/w从而/c减少/v大多/d数/nit/gi服务器架构/gi都/d存在/v的/ude1空闲/gi周期/n。/w但是/c，/w这么/rz也/d做/v带来/v了/ule不良影响/l―/w―/w无法/v找到/v足够/v资源/gi，/w使/v数据备份/nz不受/v阻碍/v地/ude2运行/gi。/w　　/nz备份/gi触到/v了/ulevmware/gi内部/f的/ude1脆弱/gi之处/r：/wvmware/gi处理/vn过量/vi磁盘/gi和/cc网络/gii/nz//nzo/nz的/ude1能力/gi很弱/a。/w实际上/d，/w决定/v是否/v将/d物理/n服务器虚拟化/gi取决于/v物理/n服务器/gi中的/v磁盘/gi密度/n、/w网络/gii/nz//nzo/nz。/w毋庸置疑/vl，/w备份/gi负载/gi是/vshivmware/gi服务器/gi承担/v的/ude1最大/gm负载/gi。/w　　/nz但是/c，/w的确/d有/vyou方法/gi能/v解决/v这些/rz问题/gi，/w并且/c在/p某些/rz情况下/nz，/w比/p标准/gi的/ude1物理/n服务器/gi备份/gi和/cc恢复/gi方法/gi更加/d出众/a。/w但是/c，/w人们/n对/p这些/rz方法/gi存在/v一些/m误解/gi，/w对/p第三方/nz备份/gi//nz恢复/gi产品/gi提供/v的/ude1实施/gi措施/gi也/d存在/v误解/gi。/w实际上/d，/w许多管理员/nz依然/d缺乏/v有效/gi实现/gi备份/gi和/cc恢复/gi的/ude1方法/gi，/w道路/n充满/v挫折/n。/w　　/nz方法/gi1/nz：/w在/p每个/rvm/nz中/f安装/gi本地/gi备份/gi程序/gi　　/nz工作原理/gi：/w这/rzv是/vshi一种/nz传统/n的/ude1备份/gi方法/gi，/w在/p每个/rvm/nz中/f安装/gi备份/gi程序/gi，/w就/d像/v以前/f在/p每/rz台/q物理/n服务器/gi中/f安装/gi备份/gi程序/gi。/w如/v下图/n所示/nz，/w数据/gi通过/plan/nz流入/v备份/gi//nz恢复/gi设施/gi，/w以往/t在/p本地/gi物理/n服务器/gi中/f安装/gi备份/gi程序/gi时/qt，/w数据/gi流向/v也/d如此/rzv。/w　　/nz这种/r方法/gi的/ude1优点/gi如下/vi：/w　　/nz备份/gi程序/gi的/ude1安装/gi和/cc配置/gi与/cc在/p物理/n服务器/gi中的/v安装/gi和/cc配置/gi十分/d相/d，/w所以/c无需/v专门/d技巧/gi和/cc程式/n变化/gi。/w　　/nz恢复/gi过程/gi没有/v发生变化/l，/w与/cc将/d文件/gi恢复/gi到/v物理/n服务器/gi的/ude1过程/gi十分/d相/d。/w　　/nz这样/rzv，/w就/d有可能/nz恢复/gi文件/gi;/nz这一点/nz在/p我们/rr采用/v其它/rz方法/gi时/qt显得/v更加/d重要/a。/w　　/nz也/d有可能/nz实现/gi完全/ad备份/gi和/cc增量/gi备份/gi，/w同样/d，/w在/p我们/rr讨论/gi其它/rz方法/gi时/qt，/w这一点/nz显得/v尤为/d重要/a。/w　　/nz如果/c你/rr采用/v专门/d的/ude1应用/gi感知/gi备份/gi程序/gi，/w如/vsql/gi或/cexchange/gi，/w这/rzv将/d有助于/v实现/gi应用程序/nz数据/gi的/ude1一致性/gi，/w由此/d实现/gi的/ude1备份/gi在/p应用程序/nz上/f具有/v一致性/gi。/w　　/nz这种/r方法/gi的/ude1缺点/gi如下/vi：/w　　/nz由于/p所有/b的/ude1备份/gi都/d在/p同一/b台/q服务器/gi中/f运行/gi，/w因而/c你/rr需要/v十分/d小心/a，/w不要/d过度/d消耗/givmware/gi主机/gi资源/gi。/w　　/nz尽管/c服务器/gi能/v封装/gi成/v少/a量/n的/ude1大型/bvmdk/nz文件/gi，/w但/c备份/gi程序/gi对此/d一无所知/vl，/w也/d就/d不能/v利用/v这一点/nz提供/v快速/d的/ude1备份/gi或/c恢复能力/gi;/nz而/cc进行/vn灾难/n恢复/gi时/qt，/w需要/v快速/d、/w全面/ad地/ude2恢复/gi服务器/gi，/w从/p这/rzv点/gi上/f讲/v，/w这种/r方法/gi价/n不大/d。/w　　/nz部署/gi技巧/gi　　/nz在/p物理/n服务器/gi中/f，/w同时/c运行/gi数据备份/nz可能/v问题/gi不大/d，/w因为/c物理/n服务器/gi具有/v充足/a的/ude1闲置/vn资源/gi，/w但是/c对/pvmware/gi虚拟/gi架构/gi而言/uls，/w闲置/vn资源/gi已/d得到/v充分利用/n，/w多/a个/q备份/gi操作/gi就/d有可能/nz阻塞/vn物理/n服务器/gi。/w从而/c，/w在/p进行/vn虚拟化/gi以后/f，/w应该/v修改/gi备份/gi手册/gi，/w通过/p备份/gi窗口/s避免/v资源/gi过度/d重叠/vi。/w　　/nz一个/mqvm/nz只/d允许/v一条/nz数据流/n。/wvm/nz的/ude1vmdk/nz文件/gi通常/d寄存/v在/p一个/mqvmfs/nz卷/q中/f，/w多/a条/q数据/gi流操作/nz很容易/nz覆盖/givmfs/nz卷/q。/w因此/c，/w除非/cvmdk/nz文件/gi隔离/vn在/p独立/a卷/q(/nzrdm/gi、/w iscsi lun/nz、/w或/c独立/a的/ude1vmfs/nz卷/q)/nz中/f，/w否则/c备份/gi就/d应该/v单流/nz运行/gi，/w而/cc不是/c多/a流/gi运行/gi。/w　　/nz方法/gi2/nz：/wesx service console/nz中/f安装/gi备份/gi程序/gi　　/nz工作原理/gi：/w这种/r方法/gi是/vshi在/pesx service console/nz在/p安装/gi备份/gi程序/gi，/w按/p下图/n备份/givm/nz中/f潜在/b的/ude1vmdk/nz文件/gi组/n。/wservice console/nz采用/v红帽子/nlinux/gi操作系统/gi，/w因此/c能够/v使用/gilinux/gi备份/gi程序/gi。/w　　/nz这种/r方法/gi的/ude1优点/gi包括/v：/w　　/nz只需/v一个/mq备份/gi程序/gi就/d能/v备份/gi所有/b的/ude1vm/nz，/w而/cc不是/c一台/nzvm/nz配备/v一个/mq备份/gi程序/gi。/w　　/nz通过/p这种/r方法/gi，/wvm/nz资源/gi能/v完全/ad备份/gi，/w只需/v简单/a备份/gi少量/mq的/ude1大型/bvmdk/nz文件/gi。/w　　/nz图像/gi能/v快速/d恢复/gi，/w因为/c只需/v恢复/gi大型/b图像/gi，/w而/cc不必/d查找/gi大量/m的/ude1小型/b图像/gi。/w　　/nz这种/r方法/gi的/ude1缺点/gi包括/v：/w　　/nz需要/v脚本/gi才能/n自动/d关闭/gi、/w快照/gi和/cc启动/givm/nz。/w为了/p保证/v备份/gi过程/gi应用程序/nz数据/gi的/ude1一致性/gi，/w必须/d这么/rz做/v。/w　　/nz不/d可能/v恢复/gi文件/gi，/w这种/r方法/gi只能/v备份/gi和/cc恢复/gi图像/gi。/w另外/c，/w这/rzv也/d意味着/v不能/v实现/gi增量/gi备份/gi。/w　　/nzvnware/nz指出/v，/w其/rz开发流程/gi包括/v从/pesx server/nz移除/vservice console/nz。/wvmware/gi的/ude1esx server /nz3/nzi/nz在/p这一点/nz上/f迈出/v了/ule第一步/nz。/w　　/nz部署/gi技巧/gi　　/nz为了/p保证/v应用程序/nz的/ude1一致性/gi，/w在/p备份/givmdk/nz之前/f应该/v关闭/givm/nz。/w　　/nzvmdk/nz文件/gi在/p备份/gi窗口/s中/f静止不动/l。/w　　/nz很/d不幸/a，/w备份/gi过程/gi中/fvm/nz失去/v效用/n。/w　　/nzvmdk/nz文件/gi利用/vservice console/nz中的/v备份/gi程序/gi进行/vn备份/gi。/w　　/nz如果/c不能/v关机/vi，/w可以/v利用/vvmware/gi快照/gi功能/gi拍摄/v运行/gi中的/vvm/nz，/w获取/gi即时/d备份/gi。/w　　/nz备份/gi数据/gi停留/vi在/p相同/a的/ude1状态/gi，/w因而/c不能/v保证数据/n的/ude1一致性/gi。/w　　/nz同样/d，/w实现/gi自动化/gi也/d需要/v脚本/gi。/w　　/nz不是/c所有/b的/ude1备份/gi程序/gi都/d支持/v这种/r方法/gi，/w所以/c你/rr需要/v事先/d进行/vn调查/gi。/w　　/nz对于/p应用程序/nz数据/gi一致性/gi的/ude1备份/gi，/w利用/vvss/nz使/v应用程序/nz在/p备份/gi之前/f停止/gi运行/gi。/w但是/c，/w这/rzv需要/v非常复杂/b的/ude1脚本/gi。/w　　/nz你/rr可以/v利用/vesx service console /nz中的/vvcb/nz设施/gi，/w获取/gi运行/gi状态/gi下/f虚拟机/gi的/ude1快照/gi：/w　　/nzvcbmounter/nz设施/gi：/w　　/nz创建/givm/nz的/ude1静态/gi快照/gi。/w　　/nz将/d快照/gi投射/v到/v一/nz组/n文件/gi中/f，/w文件/gi可能/v处于/v控制台/gi的/ude1本地/gi目录/gi中/f，/w也/d可能/v处于/vlan/nz的/ude1远程/gi目录/gi中/f。/w　　/nz利用/vesx/nz控制台/gi支持/v的/ude1备份/gi软件/gi对/p本地/gi文件/gi进行/vn备份/gi和/cc恢复/gi。/w　　/nzvcbrestore/nz设施/gi：/w　　/nz将/dvm/nz恢复/gi到/v初始/b站点/gi或者/c其它/rz站点/gi，/w　　/nz如果/c你/rr决定/v冒险/vi采用/v脚本/gi技术/gi，/w就/d会/v发现错误/l校验/v和/cc更/d正是/v脚本/gi技术/gi最难/a的/ude1一个/mq方面/n，/w需要/v编写/gi大量/m代码/gi。/w　　/nz方法/gi3/nz：/wvmware/gi集中/v备份/gi(/nzvcb/nz-/nzproxy/gi)/nz　　/nz工作原理/gi：/w这种/r方法/gi涉及/v一/nz组/nvmware/gi设施/gi，/w通常/d称为/vvmware/gi集中/v备份/gi。/w这种/r方法/gi使/v集中/v的/ude1windows /nz2003/nz代理服务器/gi中的/v非/blan/nz备份/gi与/cc相同/a的/ude1san/gi卷/q相连/vi，/w称为/vesx server/nz。/w随后/d，/w数据/gi通过/p第三方/nz备份/gi软件/gi传送/v到/v代理服务器/gi中/f，/w作为/p后序/n备份/gi。/w这种/r方法/gi比/p上述/b两/nz种/q方法/gi更为/d复杂/a，/w包括/v以下/f组件/gi：/w　　/nz备份/gi代理服务器/gi：/w　　/nz服务器/gi能/v与/ccvmware/gi主机/gi访问/gi相同/a的/ude1卷/q。/w　　/nz代理服务器/gi中/f加载/gi//nz输出/givmdk/nz文件/gi的/ude1图像/gi。/w　　/nz这种/r加载/gi//nz输出/gi图像/gi通过/p寄存/v在/p代理服务器/gi中的/v备份/gi程序实现/i备份/gi。/w　　/nzvcb/nz框架/gi：/w　　/nzesx/nz服务器/gi中的/v“/w同步/gi推动器/nz”/w能/v刷新/v文件系统/gi，/w创建/gi快照/gi。/w　　/nzvcb/nz代理服务器/gi中的/v“/wvlun/nz推动器/nz”/w允许/v服务器/gi中/f存在/vvmdk/nz文件/gi。/w　　/nz采用/vvcb/nz自动/d工作流/gi，/w命令行/n设施/gi(/nzvcbmounter/nz//nzvcbrestore/nz)/nz发挥作用/n。/w　　/nz备份/gi软件/gi集成/vn模块/gi：/w　　/nz模块/gi集成/vn到/vvcb/nz框架/gi的/ude1组件/gi中/f。/w　　/nzvmware/gi和/cc备份/gi程序/gi都/d能/v开发/gi并/cc支持/v这种/r模块/gi。/w　　/nz备份/gi程序/gi之间/f的/ude1集成/vn和/cc使用/gi变量/gi相对/d简单/a。/w　　/nz在/p此/rzs点击/v，/w查看/gi采用/v备份/gi代理服务器/gi的/ude1vmware/gi集中/v备份/gi示意图/gi。/w　　/nz采用/v备份/gi代理服务器/gi的/ude1vmware/gi集中/v备份/gi能够/v执行/v非/blan/nz文件/gi备份/gi和/cc非/blan/nz图像/gi备份/gi。/w但是/c，/w这/rzv两/nz种/q方法/gi的/ude1实现/gi途径/n截然不同/vl。/w　　/nzvcb/nz文件/gi备份/gi//nz恢复/gi是/vshi在/pvcb/nz代理服务器/gi中/f加载/givmdk/nz文件/gi，/w具体步骤/nz如下/vi：/w　　/nz1/nz备份/gi工作/gi要求/nvcb/nz框架/gi获取/givm/nz快照/gi，/w在/pvcb/nz代理服务器/gi中/f加载/givb/gi快照/gi，/w加载/gi路径/gi包括/vsan/gi、/wc/nz:/w\/nzmnt/nz等/udeng。/w　　/nz2/nz利用/v备份/gi程序/gi备份/gi(/nz完全/ad、/w增量/gi、/w差异/n备份/gi)/nz目录/gi//nz文件/gi。/w　　/nz3/nz备份/gi程序/gi要求/nvcb/nz框架/gi卸载/givm/nz快照/gi，/w使/vvm/nz不再/d具有/v快照/gi功能/gi。/w　　/nz4/nz通过/p安装/gi在/pvm/nz中的/v备份/gi程序/gi，/w文件/gi经由/plan/nz恢复/gi到/v初始/bvm/nz中/f。/w　　/nz在/p此/rzs点击/v，/w查看/gi文件/gi备份/gi和/cc恢复/gi的/ude1vcb/nz-/nzproxy/gi工作流/gi。/w　　/nzvcb/nz图像/gi备份/gi//nz恢复/gi是/vshi将/dvmdk/nz文件/gi输出/gi到/vvcb/nz代理服务器/gi中/f，/w具体步骤/nz如下/vi：/w　　/nz1./nz备份/gi工作/gi要求/nvcb/nz框架/gi获取/givm/nz快照/gi，/w并/cc输出/gi快照/gi，/w输出/gi路径/gi包括/vsan/gi、/wc/nz:/w\/nzmnt/nz等/udeng。/w　　/nz2./nz系统文件/gi等/udeng输出/gi的/ude1图像文件/nz通过/p备份/gi程序/gi进行/vn备份/gi。/w　　/nz3./nz备份/gi软件/gi要求/nvcb/nz框架/gi卸载/givm/nz快照/gi，/w使/vvm/nz不再/d具有/v快照/gi功能/gi。/w　　/nz4./nz利用/v备份/gi程序/gi，/w将/d输出/gi的/ude1vm/nz图像/gi恢复/gi到/v一个/mqvmware/gi能够/v访问/gi的/ude1临时/gi区域/n，/w该/rz区域/n可能/v位于/vproxy server /nz或/cesx service console/nz，/w由此/d完成/v恢复/gi工作/gi。/w　　/nz5./nzvm/nz图像/gi加载/gi到/vesx/nz主机/gi中的/v指定/v位置/gi。/w　　/nz在/p此/rzs点击/v，/w查看/gi图像/gi备份/gi和/cc恢复/gi的/ude1vcb/nz-/nzproxy/gi工作流/gi。/w　　/nz这种/r方法/gi的/ude1优点/gi包括/v：/w　　/nz你/rr可以/v利用/vvcb proxy/nz中/f一个/mq备份/gi程序/gi，/w备份/gi所有/b的/ude1vm/nz，/w而/cc不必/d每个/rvm/nz配备/v一个/mq程序/gi。/w　　/nz通过/p这种/r方法/gi，/wvm/nz资源/gi能/v完全/ad备份/gi，/w只需/v简单/a备份/gi少量/mq的/ude1大型/bvmdk/nz文件/gi。/w　　/nz图像/gi能/v快速/d恢复/gi，/w因为/c只需/v恢复/gi大型/b图像/gi，/w而/cc不必/d查找/gi大量/m的/ude1小型/b图像/gi。/w　　/nz将/d备份/gi过程/gi转移/v到/vvcb/nz代理服务器/gi中/f，/w降低/v了/uleesx/nz服务器/gi的/ude1开销/n。/w　　/nz这种/r备份/gi方法/gi无需/vlan/nz，/w在/psan/gi中/f也/d能/v实现/gi，/w从/p理论上/nz讲/v，/w备份/gi速度/n比/p基于/plan/nz的/ude1备份/gi方法/gi要/v快/a。/w　　/nz这种/r方法/gi的/ude1缺点/gi包括/v：/w　　/nz能否/v实现/gi自动化/gi、/w能否/v方便/a地/ude2加以/vx使用/gi取决于/v第三方/nz备份/gi软件/gi的/ude1能力/gi。/w　　/nz如果/c没有/v某种/rz形式/gi的/ude1备份/gi软件/gi集成/vn到/v备份/gi过程/gi中/f，/w要/v部署/gi这种/r方法/gi就/d变得/vi非常复杂/b。/w　　/nz如果/c你/rr想/v将/d文件/gi直接/ad恢复/gi到/vvm/nz中/f，/w就/d需要/v在/pvm/nz中/f安装/gi备份/gi软件/gi。/w　　/nz对于/p没有/v集成/vnvss/nz的/ude1windows系统/gi，/w由/pvcb/nz提供/v的/ude1图像/gi备份/gi会/v使/v数据处于/nz相同/a的/ude1状态/gi。/w　　/nzvcb/nz不/d提供/vwindows系统/gi状态/gi的/ude1恢复/gi机制/gi，/w尽管/c有可能/nz成功/a实现/gi服务器/gi完全恢复/i，/w但是/c如果/c在/p操作/givm/nz时/qt，/w系统/gi状态/gi紊乱/an，/w就/d不能/v保证/v完全恢复/i。/w　　/nz部署/gi技巧/gi　　/nz请/v记住/v，/wvcb/nz不是/c备份/gi//nz恢复程序/n，/w而是/c一/nz组/n能/v集成/vn到/v第三方/nz备份/gi应用程序/nz中的/v设施/gi。/w　　/nzproxy server/nz不是/c虚拟机/gi。/w　　/nzvcb/nz不能/v安装/gi在/p虚拟/gi中心/gi的/ude1服务器/gi中/f，/w也/d不能/v注册/gi。/w　　/nzproxy server/nz需要/v安装/giwindows /nz2003/nz server/nz、/wsp/nz1/nz或/cr/nz2。/nz　　/nzproxy server/nz必须/d和/ccesx servers/nz安装/gi在/p相同/a的/ude1lun/nz区域/n中/f。/w　　/nzvcb proxy server/nz不/d支持/v多路径/n。/w　　/nz如果/c需要/v恢复/gi文件/gi，/w但/c你/rr又/d不想/v为/p每个/rvm/nz都/d安装/gi备份/gi程序/gi，/w你/rr就/d可以/v创建/gi一个/mq仅/d用于/v恢复/gi的/ude1vm/nz，/w这个/rzvm/nz包含/v备份/gi和/cc恢复程序/n，/w将/d文件/gi恢复/gi到/v这个/rzvm/nz中/f，/w然后/c通过/p网络共享/nz将/d文件/gi迁移/gi到/v正确/a的/ude1目标/givm/nz中/f。/w