#《/wCSAPP/nz》/w虚拟存储器/gi
前言/gi：/w虚拟存储器/gi这/rzv一/nz部分/n也/d是/vshi我/rr一直/d以来/f没有/v理解/gi的/ude1，/w这/rzv一/nz章/q对于/p整体/n理解/gi计算机系统/gi非常/d的/ude1重要/a，/w需要/v彻底/ad弄/v明白/v。/w我/rr的/ude1github/gi：/w我/rr实现/gi的/ude1代码/gi全部/m贴/v在/p我/rr的/ude1github/gi中/f，/w欢迎/v大家/rr去/vf参观/v。/w第九章/nz：/w虚拟存储器/gi虚拟存储器/gi的/ude1作用/gi：/w一/nz、/w虚拟存储器/gi的/ude1能力/gi：/w1./nz /x为/p每个/r进程/gi提供/v一个/mq大/a的/ude1一致/a的/ude1和/cc私有/gi的/ude1地址/gi空间/n：/w虚拟存储器/gi是/vshi硬件/gi异常/gi，/w硬件地址/nz翻译/gi，/w主存/gi，/w磁盘/gi文件/gi和/cc内核/gi软件/gi的/ude1完美/a交互/gi。/w2./nz /x它/rr将/d主存/gi看做/v是/vshi一个/mq存储/gi在/p磁盘/gi上/f的/ude1地址/gi空间/n的/ude1高速缓存/gi，/w在/p主存/gi中/f只/d保存/gi活动/gi区域/n，/w并/cc更/d局/n需要/v在/p磁盘/gi和/cc主存/gi中/f来回/vd传送数据/n。/w这种/r方式/n，/w高效/b的/ude1使用/gi了/ule主存/gi。/w3./nz /x为/p每个/r进程/gi提供/v了/ule一致/a的/ude1地址/gi空间/n，/w从而/c简化/gi了/ule /x存储器/gi管理/gi4./nz /x保护/gi了/ule每个/r进程/gi的/ude1地址/gi空间/n不受/v其他/rzv进程/gi破坏二/nz、/w为什么/ryv需要/v理解/gi虚拟存储器/gi：/w1./nz虚拟存储器/gi是/vshi中心/gi：/w它/rr编辑/gi计算机系统/gi的/ude1所有/b层面/n，/w从/p硬件/gi异常/gi，/w汇编器/n，/w链接/gi器/ng，/w加载器/nz，/w共享/gi对象/gi，/w文件/gi和/cc进程/gi的/ude1设计/gi中/f扮演着/n重要/a的/ude1角色/gi2./nz /x虚拟存储器/gi是/vshi强大/a的/ude1：/w它/rr给与/v应用程序/nz强大/a的/ude1能力/gi。/w可以/v创建/gi和/cc销毁/v存储器/gi片/q，/w将/d存储器/gi片/q映射/gi到/v磁盘/gi文件/gi的/ude1某个/rz部分/n，/w以及/cc与/cc其他/rzv进程/gi共享存储器/gi。/w3./nz /x虚拟存储器/gi是/vshi危险/an的/ude1：/w每次/r应用程序/nz引用/gi一个/mq变量/gi，/w间接/b引用/gi一个/mq指针/gi，/w或者/c调用/gi如/vmalloc/nz这样/rzv的/ude1动态分配/l程序/gi时/qt，/w它/rr就/d会/v和/cc虚拟存储器/gi发生/v交互/gi。/w页/q与/cc页表/gi：/w一/nz、/w虚拟存储器/gi被/pbei分割/gi成/v虚拟页/nz：/w每个/r虚拟页/nz的/ude1大小/n为/pp /nz=/nz2/nz /x^/nzp/nz，/w类/gi的/ude1，/w物理/n存储器/gi也/d被/pbei分割/gi成/v物理页/nz，/w大小/n也/d为/pp/nz字节/gi。/w物理页/nz称为/v页帧二/nz、/w页表/gi用来/v索引/gi物理页/nz：/w页表/gi将/d虚拟页/nz映射/gi到/v物理页/nz，/w每次/r地址/gi翻译/gi，/w硬件/gi将/d一个/mq虚拟地址/gi转换/gi为/p物理地址/gi的/ude1时候/n都会/n读取/gi页表/gi。/w页表/gi就是/v一个/mq页表/gi条目/n组成/gi的/ude1数组/gi（/wpte/nz）/w，/w每个/rpte/nz都/d由/p一个/mq有效/gi位/q和/cc一个/mq地址/gi组成/gi。/w二/nz、/w页命/nz中/f与/cc缺页/gi：/w1./nz /x读取/gi已经/d缓存/gi的/ude1虚拟页/nz，/w将/d会/v调用/gi地址/gi翻译/gi硬件/gi，/w将/d虚拟地址/gi用来/v定义/gi对应/vi的/ude1pte/nz，/w然后/c找到/v对应/vi的/ude1物理地址/gi。/w2./nz /x缺页/gi就是/v访问/gi的/ude1虚拟页/nz未有/vdram/nz缓存/gi，/w会/v触发/gi缺页/gi处理程序/n，/w系统/gi选择/gi牺牲/v一个页/nz，/w然后/c将/d该/rz虚拟页/nz缓存/gi。/w虚拟存储器/gi管理/gi存储器/gi：/w一/nz、/w操作系统/gi为/p每/rz一个/mq进程/gi提供/v了/ule一个/mq独立/a的/ude1页表/gi：/w1./nz /x简化/gi链接/gi：/w独立/a的/ude1地址/gi空间/n允许/v每个/r进程/gi的/ude1存储器/gi映/vi像/v使用/gi相同/a的/ude1基本/a式/k，/w而/cc不用/d管/v代码/gi和/cc数据/gi实际/n存放在/v物理/n存储器/gi的/ude1何处/rys。/w2./nz /x简化/gi加载/gi：/w3./nz /x简化/gi共享/gi：/w可以/v通过/p虚拟页/nz指向/v同一个/b物理页/nz来/vf完成/v共享/gi。/w4./nz /x简化/gi存储器/gi分配/gi：/w当/p用户/gi使用/gimalloc/nz等/udeng函数/gi时/qt，/w可以/v分配/gi连续/gi的/ude1虚拟页/nz，/w但是/c可以/v不用/d分配/gi连续/gi的/ude1物理/n页二/nz、/w虚拟页/nz作为/p存储器/gi保护/gi工具/gi：/w在/ppte/nz中/f添加/gi保护/gi标志/n位/q，/w就/d可以/v控制/vn对/p虚拟/gi页面/gi上/f内容/gi的/ude1访问/gi权限/gi。/w存储器/gi映射/gi：/w一/nz、/w定义/gi：/w通过/p将/d一个/mq虚拟存储器/gi区域/n与/cc一个/mq磁盘/gi上/f的/ude1对象/gi关联/vn起来/vf，/w以/p初始化/v这个/rz虚拟存储器/gi的/ude1内容/gi，/w这个/rz过程/gi称为/v储存器/nz映射/gi，/w可以/v映射/gi到/v两/nz种/q对象/gi：/w1./nz unix/nz文件系统/gi中的/v普通/a文件/gi。/w2./nz /x匿名/vn文件。二/nz、/w共享/gi对象/gi与/cc私有对象/gi：/w1./nz /x一个/mq对象/gi可以/v被/pbei映射/gi到/v虚拟存储器/gi的/ude1一个/mq区域/n作为/p共享/gi对象/gi：/w如果/c一个/mq进程/gi将/d一个/mq共享/gi对象/gi映射/gi到/v它/rr的/ude1虚拟地址/gi空间/n内/f，/w那么/c这个/rz进程/gi对/p这个/rz区域/n的/ude1任何/rz写/v操作/gi，/w对于/p其他/rzv那些/rz也/d把/pba共享/gi对象/gi映射/gi到/v他们/rr虚拟/gi储存器/nz区域内/nz的/ude1进程/gi也/d是/vshi可见/c的/ude1。/w2./nz /x私有对象/gi与/cc上/f相反/vi，/w其他/rzv进程/gi是/vshi不/d可见/c对/p私有对象/gi的/ude1修改/gi的/ude1。/w二/nz、/w共享/gi对象/gi与/cc私有对象/gi：/w如果/c两/nz个/q进程/gi将/d一个/mq私有对象/gi映射/gi到/v他们/rr的/ude1虚拟/gi储存器/nz中/f，/w但是/c共享/gi这个/rz对象/gi的/ude1一个/mq物理/n拷贝/gi，/w对于/p每一个/nz映射/gi私有对象/gi的/ude1进程/gi，/w相应/vi的/ude1私有对象/gi的/ude1页条/nz目表/nz都/d被/pbei标记/gi为/p只读/v，/w并且/c区域/n结构/gi被/pbei标记/gi为/p私有/gi的/ude1写/v时/qt拷贝/gi。/w只要/c有/vyou一个/mq进程/gi试图/v写/v它/rr自己/rr的/ude1私有/gi区域/n，/w就/d会/v引起/v一个/mq保护/gi故障/gi，/w故障/gi处理程序/n会/v在/p物理/n储存器/nz中/f创建/gi一个/mq新的/a拷贝/gi，/w然后/c恢复/gi这个/rz页面/gi的/ude1可写/v权限/gi。/w此时/r进程/gi就/d指向/v各自/rr的/ude1独立/a的/ude1物理/n内存/gi区域/n了/ule。/w总结/gi：/w虚拟/gi储存器/nz理解/gi了/ule之后/f，/w就/d能/v知道/v为什么/ryv汇编/gi中/f，/w代码段/nz总是/d在/p0/nzx/nz8048000/nz开始/v了/ule。/w也/d明白/v了/ule进程/gi中的/v内存/gi到底/d是/vshi如何/ryv组织/gi的/ude1。/w现在/t对/p已/d操作系统/gi中的/v进程/gi运行/gi流程/gi，/w已经/d有/vyou了/ule一个/mq非常/d全面/ad的/ude1理解/gi了/ule。/w对于/p以后/f的/ude1编程/gi会/v有/vyou非常/d大/a的/ude1帮助/v。/w