#spring/gi对/psession/gi和/cc事务/gi的/ude1管理/gi以及/ccOpenSessionInViewFilter/nz是/vshi如何/ryv工作/gi的/ude1
为了/p弄清楚/nzspring/gi对/psession/gi和/cc事务/gi的/ude1管理/gi以及/cc是/vshi如何/ryv工作/gi的/ude1，/w可/v监控/gi以下/f类/gi的/ude1日志/gi：/w具体/a可/v参考/gi下面/f的/ude1配置/gi：/w下面/f是/vshi在/p一个/mq不/d使用/gi的/ude1项目/gi中/f，/w一次/nz请求/gi(/nz所有/b条目/n都/d是/vshi在/p一个/mq线程/gi里/f的/ude1)/nz调用/gi两/nz次/qv方法/gi（/w此/rzs方法/gi上/f声明了/nz事务/gi控制/vn）/w打出/v的/ude1日志/gi：/w /x日志/gi中/f可以/v清楚/a地/ude2看到/v：/w每次/r事务/gi开启/gi时会/n打开/gi一个/mq新的/a，/w事务/gi结束/v时会/n关闭/gi该/rzsession/gi,/nzsession/gi不再/d和/cc当前/t线程/gi绑定/gi。/w下面/f是/vshi在/p一个/mq使用/gi了/ule的/ude1项目/gi中/f，/w一次/nz请求/gi(/nz所有/b条目/n都/d是/vshi在/p一个/mq线程/gi里/f的/ude1)/nz调用/gi两/nz次/qv方法/gi（/w此/rzs方法/gi上/f声明了/nz事务/gi控制/vn）/w打出/v的/ude1日志/gi：/w /x日志/gi中/f可以/v清楚/a地/ude2看到/v：/w请求/gi刚/d发起/v时/qt就/d会/v创建/gi一个/mqsession/gi实例/gi，/w并/cc绑定/gi到/v当前/t线程/gi上/f，/w至/p请求/gi结束/v时/qt，/w关闭/gi该/rz线程/gi。/w在/p请求/gi期间/f所有/b事务/gi都/d使用/gi这/rzv一个/mqsession/gi。/w /x　　/nz另一方面/c我们/rr还/d可以/v看到/v：/w数据库/gi连接/giconnection/nz保持/v打开/gi的/ude1时间/gi正是/v事务/gi从/p开始/v到/v提交/gi的/ude1时间/gi，/w为了/p测试/gi，/wgetrole/nz方法/gi中/f故意/d设定/v了/ule3/nz秒/qt的/ude1延迟/v，/w从/p日志/gi上/f看出/v数据库/gi连接/gi也/d基本上/d维持/v了/ule3/nz秒/qt。/w这/rzv是/vshi很/d多/a系统/gi出现/v无法/v获取/gi数据库/gi连接/gi问题/gi的/ude1原因/n。/w在/p一个/mq使用/gi了/ule连接池/nz的/ude1系统/gi里/f，/w连接数/nz有/vyou一个/mq最大/gm上限/n，/w如果/c某个/rz请求/gi的/ude1处理/vn耗时/vi过长/n，/w则/d当前/t数据库/gi连接/gi在/p短时间/nz内/f就/d得不到/v释放/gi。/w当前/t并发/gi访问量/nz急速/z上升时/n，/w连接池/nz的/ude1连接/gi用/p会/v迅速/ad用光/n，/w导致/gi后续/vn的/ude1请求/gi因/p无法/v得到/v数据库/gi连接/gi而/cc失败/vi。/w /x　　/nz最后/f，/w至于/p为什么/ryv只/d需要/v保证/vsession/gi一直/d打开/gi就/d能避免/nzlazy loading/nz时/qt不/d报错/nz，/w原因/n就/d在于/v，/w观察/gi下面/f的/ude1log/gi可以/v发现/v，/w每当/p在/p事务/gi期间/f时/qt就/d被/pbei禁用/gi，/w事务/gi一/nz执行/v完毕/vi就/d又/d恢复/gi至/p可用/v。/w这样/rzv，/w在/pjsp/gi页面/gi上/f读取/gilazy/nz对象/gi时/qt，/w并/cc不是/c以/p事务/gi方式/n进行/vn的/ude1，/w而是/c以/p的/ude1方式/n提交/giselect/nz语句/gi的/ude1。/w因此/c只/d需要/v保持/vsession/gi打开/gi即可/v，/w无需/v事务/gi的/ude1支持/v。/w