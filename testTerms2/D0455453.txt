#两/nz阶段/gi提交/gi协议/gi（/w2/nzPC/nz）/w
对于/p两阶段协议/gi，/w只要/c学/v过/uguo《/w数据库/gi基本原理/nz》/w这/rzv本书/gi的/ude1应该/v对/p这个/rz名词/n比较/gi熟悉/v，/w当时/t在/p本科/n的/ude1时候/n，/w学/v过/uguo这个/rz协议/gi，/w结果/n在/p后面/f却/d完全/ad忘了/v这个/rz协议/gi，/w直到/v在/p后面/f《/w大数据存储/gi》/w里面/f有/vyou一道/d关于/p两阶段协议/gi的/ude1题/n后/f才/d引起/v了/ule我/rr对/p这个/rz协议/gi的/ude1了解/v。/w两阶段协议/gi分/qt两/nz个/q阶段/gi，/w投票/vi阶段/gi和/cc决定/v阶段/gi：/w（/w1/nz）/w投票/vi阶段/gi1./nz /x协调者/n发送/gi一个/mqvote/nz-/nzreq/nz消息/n给/p所有/b的/ude1参与者/gi2./nz /x当/p参与者/gi接收/gi到/vvote/nz-/nzreq/nz消息/n后/f，/w它/rr会/v发送/gi一个/mq包含/v参与者/gi投票/vi结果/n的/ude1消息/n(/nzyes/nz或/cno/nz)/nz给/p协调者/n作为/p响应/v。/w如果/c参与者/gi投/v的/ude1是/vshino/nz，/w它/rr会/v决定/vabort/nz事务/gi并/cc停止/gi运行/gi（/w2/nz）/w决定/v阶段/gi1./nz /x协调者/n收集/v来自/v所有/b参与者/gi的/ude1投票/vi信息/gi。/w如果/c所有/b的/ude1消息/n都/d是/vshiyes/nz，/w同时/c协调者/n投/v的/ude1也/d是/vshiyes/nz，/w那么/c协调者/n就/d会/v决定/v进行/vncommit/nz，/w并/cc向/p所有/b参与者/gi发送/gicommit/nz消息/n。/w否则/c协调者/n就/d会/v决定/v进行/vnabort/nz，/w并/cc向/p所有/b投/vyes/nz的/ude1参与者/gi发送/giabort/nz消息/n(/nz那些/rz投/vno/nz的/ude1参与者/gi已经/d在/p第一/mq阶段第/nz2/nz步/qv中/f决定/vabort/nz了/ule)/nz。/w之后/f，/w对于/p这/rzv两/nz种/q情况/n协调者/n都会/n停止/gi运行/gi2./nz /x每个/r投/vyes/nz的/ude1参与者/gi等待/gi来自/v协调者/n的/ude1commit/nz或/cabort/nz消息/n。/w收到/v消息/n后/f执行/v相应/vi动作/gi然后/c停止/gi运行/gi。/w这个/rz协议/gi看起来/v好像/v有点/d不近人情/vl，/w只要/c有一人/nz没有/v做出/v肯定/v的/ude1回复/v，/w整个/b动作/gi就要/d被/pbei取消/v。/w举/v个/q例子/gi说明/v吧/y，/w上面/f的/ude1好像/v有点/d抽象/gi：/w假设/gi一个/mq寝室/n有/vyou四人/nz：/wa/nz、/wb/nz、/wc/nz、/wd/nz，/w有一天/d室长/nnta/nz说明天/nz大家/rr一起/s去/vf看电影/nz吧/y。/wb/nz回复/v：/w好/a吧/yc/nz回复/v：/w行/ng但是/c此时/rd/nz不在/v寝室/n，/w室长/nnt就/d发/v个/q短信/n给/pd/nz，/w但是/cd/nz一直/d没有/v看/v手机/gi，/w直到/v会/v寝室/n才/d直到/v这/rzv件/q事/n，/w此时/r他/rr却说/v，/w不好意思/a，/w我们/rr明天/t有约/v。/w室长/nnt，/w说/v那/rzv我们/rr明天/t就/d不/d去/vf吧/y，/w就/d这样/rzv看电影/nz活动/gi就/d被/pbei取消/v。/w这/rzv就是/v两阶段协议/gi，/w在/p分布式系统/gi中的/v应用/gi就是/v，/w只有/c全部/m的/ude1结果/n能/v通过/p才/d通过/p，/w这样的话/l就/d会/v保证数据/n的/ude1一致性/gi。/w