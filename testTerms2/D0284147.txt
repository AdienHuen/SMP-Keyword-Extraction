#消息/n转发/gi
1./nz消息/n中转/gith/nz项目/gi利用/v交换/gi服务器/gi为/p跨/v服务器/gi通信/gi提供/v消息/n中转/gi服务/gi./nz交换/gi服务器/gi负责/v：/w./nz接受/gi服务器/gi登记/gi./nz登记/gi信息/gi保存/gi在/pmysql/gi中/f,/nz以便/d所有/b服务器/gi共享/gi访问/gi./nz./nz负责/v转发/gi./nz处理/vn有限/a的/ude1协议/gi实现/gi时/qt以/p用户/gi上线/n通知/gi为/p例/n。/w用户/gia/nz在/ps/nz1/nz服务器/gi上/f登录/gi,/nz需要/v把/pba该/rz用户/gi上线/n的/ude1消息/n发送给/n在/p其它/rz服务器/gi登录/gi的/ude1同事/n和/cc好友/n./nzs/nz1/nz确定/v用户/gia/nz的/ude1同事/n和/cc好友/n信息/gi：/w。/w在/ps/nz1/nz上/f登录/gi的/ude1。/w在/p其它/rz服务器/gi上/f登录/gi的/ude1转发/gi消息/n包含/v2/nz部分/n：/w消息/n本身/rz以及/cc目标/gi信息/gi。/w目标/gi信息/gi用于/v转发/gi处理/vn，/w包括/v服务器/gi行集/nz，/w而/cc服务器/gi记录/gi包含/v用户/gi行集/nz。/w转发/gi消息/n(/nz905/nz-/nzrequest/nz)/nz。/w交换/gi服务器/gi转发/gi的/ude1消息/n。/w目标/gi为/p交换/gi服务器/gi(/nz3/nz,/nz0/nz)/nz。/w原始/a消息/n的/ude1目标/gi设置/gi为/p(/nz0/nz,/nz0/nz)/nz：/w对于/p接收/gi的/ude1客户端/gi而言/uls,/nz未指定/l目标/gi就是/v客户端/gi自己/rr。/w服务器/gi行集/nz，/w每条/d记录/gi为/p该/rz服务器/gi上/f的/ude1用户/gi行集/nz转发/gi消息/n(/nz906/nz-/nzrequest/nz）/w。/w应用服务器/gi转发/gi的/ude1消息/n。/w目标/gi为/p服务器/gi。/w用户/gi行集/nz：/w记录/gi该/rz服务器/gi上/f需要/v发送/gi的/ude1客户端/gi当/p一个/mq消息/n需要/v发送给/n跨/v多/a个/q服务器/gi上/f的/ude1用户/gi时/qt,/nz需要/v通过/p交换/gi服务器/gi中转/gi./nziim/nz接口/gi的/ude1send/nz(/nzcmsg /nz*/nzmsg/nz,/nzuser/gi_/nzlist user/nz_/nzlist/gi)/nz方法/gi为此/bl提供/v统一/vn的/ude1入口/n./nz避免/v消息/n多/a个/q副本/n./nz只/d向/p交换/gi服务器发送/n一个/mq用户/gi消息/n转发/gi请求/gi(/nz905/nz-/nzrequest/nz)/nz./nz消息/n中/f包含/v了/ule需要/v转发/gi的/ude1服务器/gi列表/vi和/cc每个/r服务器/gi上/f的/ude1用户/gi,/nz服务器/gi和/cc用户/gi都/d包含/v了/ule通道/n信息/gi./nz交换/gi服务器/gi和/cc接收/gi服务器/gi直接/ad利用/v通道/n信息/gi发送/gi./nz交换/gi服务器/gi把/pba消息/n(/nz906/nz-/nzrequest/nz)/nz发送给/n目标/gi服务器/gi./nz目标/gi服务器/gi接收/gi后/f还原/gi原始/a消息/n发送给/n客户端/gi./nz转发/gi消息/n具有/v和/cc原始/a消息/n相同/a的/ude1时序/n控制/vn属性/gi./nz。/w多目标/gi用户/gi消息/n发送/gi：/w通过/piim/nz接口/gi为/p其它/rz插件/gi使用/gi./nz取得/vuser/gi_/nzlist/gi可/v优化/gi,/nz查询/gi时/qt已经/d得到/v服务器/gi上/f用户/gi的/ude1分布/vi和/cc通道/n信息/gi,/nz提高/v性能/gi./nz。/w交换/gi服务器/gi中转/gi。/w应用服务器/gi中转/gi2./nz备忘/nz2.1/nz用户/gi状态/gi信息/gi用户/gi状态/gi运行/gi时/qt动态/gi改变/v，/w需要/v反映/v到/v同事/n和/cc好友/n的/ude1客户端/gi上/f。/w短时间/nz的/ude1不/d一致/a不是/c问题/gi，/w但/c必须/d有/vyou一种/nz机制/gi保证/v最终/d可以/v处于/v一致/a的/ude1状态/gi./nz通知/gi消息/n的/ude1多/a段/q传输/gi过程/gi中/f,/nz由于/p进程/gi或/c网络/gi原因/n,/nz消息/n不一定会/nz发送到/l用户/gi的/ude1所有/b在线/vn好友/n和/cc同事/n./nz数据库/gi中/f记录/gi的/ude1用户/gi状态/gi时/qt准确/a的/ude1，/w新/a上线/n的/ude1同事/n和/cc好友/n所/usuo得到/v的/ude1用户/gi状态/gi是/vshi正确/a的/ude1./nz有/vyou2/nz种/q解决方法/gi：/w。/w利用/v以/p内存数据库/gi作为/p存储/gi的/ude1semq/nz：/w在/p发送/gi服务器/gi和/cc接受/gi服务器之间/n确认/v,/nz相关/vn信息/gi全/a部/q保存/gi在/p内存/gi中/f./nz服务器/gi负责/v自己/rr写入/gi的/ude1记录/gi,/nz重启/gi时/qt删除/gi历史记录/nz./nz。/w利用/v事件/gi中心/gi：/w这/rzv是/vshi后话/n./nz /x利用/v内存/gi表/n作为/p存储/gi可/v提高/v性能/gi./nz或者/c等待/gi下/f一次/nz用户/gi状态/gi改变/v./nz /x*/nz*/nz*/nz目前/t没有/v对此/d进行/vn处理/vn./nz2.2/nz聊天/gi消息/n从/p可靠性/gi角度/n,/nz在线/vn聊天/gi的/ude1消息/n也/d应该/v写入/gi数据库/gi后/f再/d发送/gi，/w由/psemq/nz负责/v送达/v和/cc控制/vn时序/n./nz否则/c，/w多/a段/q传输/gi中的/v环节/gi进程/gi或/c网络故障/nz都/d可能/v导致/gi消息/n不能/v被/pbei送达/v。/w但/c这种/r设计/gi可靠/a但/c增加/v了/ule负载/gi和/cc延迟/v./nz对于/p在线/vn聊天/gi消息/n,/nz应该/v在/p客户端/gi之间/f确认/v./nz2.3/nzumx/nz的/ude1一个/mq缺陷/gi今天/t发现/v一个/mq缺陷/gi./nzumx/nz支持/v参数/gi为/p消息/n类型/gi./nz但是/c,/nz消息/n不能/v是/vshiumxt/nz的/ude1消息/n./nz这/rzv是因为/cumxt/nz没有/v重载/vncalcsize/nz方法/gi,/nz导致/gi序列化/gi失败/vi./nzumxt/nz在/pstream/nz时/qt才/d把/pba传输/gi属性/gi加入/v消息/n包/v中/f./nz